<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... (mantén tus metadatos y estilos existentes) ... -->
    
    <!-- Agrega los SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <style>
        /* ... (mantén tus estilos existentes) ... */
        
        /* Agrega estilos para el sistema de autenticación */
        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .auth-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 0.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .delete-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(247, 37, 133, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .gallery-item:hover .delete-btn {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sección de autenticación -->
        <div class="auth-section" id="authSection">
            <div id="authState">
                <p>Inicia sesión para subir imágenes</p>
                <button id="loginBtn" class="auth-btn">Iniciar sesión</button>
                <button id="registerBtn" class="auth-btn">Registrarse</button>
            </div>
        </div>
        
        <h1>Galería Cloudinary Mejorada</h1>
        
        <!-- ... (mantén el resto de tu HTML existente) ... -->
    </div>

    <!-- ... (mantén tu modal existente) ... -->

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD3MI1klgBSHs1h6QT4VPNoScCfCwMV_Ck",
            authDomain: "usuario-b0384.firebaseapp.com",
            databaseURL: "https://usuario-b0384-default-rtdb.firebaseio.com",
            projectId: "usuario-b0384",
            storageBucket: "usuario-b0384.firebasestorage.app",
            messagingSenderId: "196266170863",
            appId: "1:196266170863:web:4ea57f489df94aba94fe1a"
        };
        
        // Inicializa Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Configuración de Cloudinary (mantén tu configuración existente)
        const cloudName = 'dba9d8';
        const apiKey = '528757166221984';
        const unsignedUploadPreset = 'web_upload';
        
        // Elementos del DOM (agrega los nuevos)
        const authSection = document.getElementById('authSection');
        const authState = document.getElementById('authState');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        
        // ... (mantén tus otras variables existentes) ...
        
        // Estado del usuario
        let currentUser = null;
        
        // Cargar imágenes al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            setupAuthListeners();
            loadImagesFromFirebase();
            setupEventListeners();
        });
        
        function setupAuthListeners() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateAuthUI();
                
                if (user) {
                    loadImagesFromFirebase();
                }
            });
            
            loginBtn.addEventListener('click', () => {
                // Implementa tu lógica de inicio de sesión
                const email = prompt("Ingresa tu email:");
                const password = prompt("Ingresa tu contraseña:");
                
                if (email && password) {
                    auth.signInWithEmailAndPassword(email, password)
                        .catch(error => {
                            showStatus(`Error al iniciar sesión: ${error.message}`, 'error');
                        });
                }
            });
            
            registerBtn.addEventListener('click', () => {
                // Implementa tu lógica de registro
                const email = prompt("Ingresa tu email para registrarte:");
                const password = prompt("Crea una contraseña:");
                
                if (email && password) {
                    auth.createUserWithEmailAndPassword(email, password)
                        .then(() => {
                            showStatus('¡Registro exitoso!', 'success');
                        })
                        .catch(error => {
                            showStatus(`Error al registrarse: ${error.message}`, 'error');
                        });
                }
            });
        }
        
        function updateAuthUI() {
            if (currentUser) {
                authState.innerHTML = `
                    <div class="user-info">
                        <img src="https://ui-avatars.com/api/?name=${currentUser.email}&background=random" 
                             alt="Avatar" class="user-avatar">
                        <p>Bienvenido, ${currentUser.email}</p>
                        <button id="logoutBtn" class="auth-btn">Cerrar sesión</button>
                    </div>
                `;
                
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    auth.signOut();
                });
                
                // Mostrar sección de subida solo para usuarios autenticados
                document.querySelector('.upload-section').style.display = 'block';
            } else {
                authState.innerHTML = `
                    <p>Inicia sesión para subir imágenes</p>
                    <button id="loginBtn" class="auth-btn">Iniciar sesión</button>
                    <button id="registerBtn" class="auth-btn">Registrarse</button>
                `;
                
                // Ocultar sección de subida para usuarios no autenticados
                document.querySelector('.upload-section').style.display = 'none';
                
                // Reasignar event listeners a los nuevos botones
                document.getElementById('loginBtn').addEventListener('click', () => {
                    const email = prompt("Ingresa tu email:");
                    const password = prompt("Ingresa tu contraseña:");
                    
                    if (email && password) {
                        auth.signInWithEmailAndPassword(email, password)
                            .catch(error => {
                                showStatus(`Error al iniciar sesión: ${error.message}`, 'error');
                            });
                    }
                });
                
                document.getElementById('registerBtn').addEventListener('click', () => {
                    const email = prompt("Ingresa tu email para registrarte:");
                    const password = prompt("Crea una contraseña:");
                    
                    if (email && password) {
                        auth.createUserWithEmailAndPassword(email, password)
                            .then(() => {
                                showStatus('¡Registro exitoso!', 'success');
                            })
                            .catch(error => {
                                showStatus(`Error al registrarse: ${error.message}`, 'error');
                            });
                    }
                });
            }
        }
        
        function loadImagesFromFirebase() {
            gallery.innerHTML = ''; // Limpiar galería
            
            database.ref('images').once('value').then(snapshot => {
                const imagesData = snapshot.val() || {};
                
                Object.keys(imagesData).forEach(key => {
                    createGalleryItem(imagesData[key]);
                });
            });
        }
        
        function createGalleryItem(imgData) {
            const galleryItem = document.createElement('div');
            galleryItem.className = 'gallery-item';
            galleryItem.dataset.id = imgData.id;
            
            galleryItem.innerHTML = `
                <img src="${imgData.secure_url}" alt="Imagen subida" class="gallery-img">
                <div class="gallery-info">
                    <p><strong>Tamaño:</strong> ${(imgData.bytes/1024).toFixed(1)} KB</p>
                    <p><strong>Subido por:</strong> ${imgData.uploadedBy || 'Anónimo'}</p>
                    <p class="gallery-url">${imgData.public_id || 'Imagen subida'}</p>
                </div>
                <button class="copy-btn" title="Copiar URL" data-url="${imgData.secure_url}">
                    <i class="fas fa-copy"></i>
                </button>
                ${currentUser && currentUser.uid === imgData.uploadedByUid ? 
                    `<button class="delete-btn" title="Eliminar imagen">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
            `;
            
            gallery.appendChild(galleryItem);
            
            // Evento para expandir imagen
            galleryItem.querySelector('img').addEventListener('click', () => {
                expandedImg.src = imgData.secure_url;
                modal.style.display = "flex";
            });
            
            // Evento para copiar URL
            galleryItem.querySelector('.copy-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                copyToClipboard(imgData.secure_url, e.currentTarget);
            });
            
            // Evento para eliminar imagen (si existe el botón)
            const deleteBtn = galleryItem.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('¿Estás seguro de que quieres eliminar esta imagen?')) {
                        deleteImage(imgData.id, imgData.public_id);
                    }
                });
            }
        }
        
        async function uploadImage() {
            const file = fileInput.files[0];
            if (!file || !currentUser) return;
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = 'Subiendo... <i class="fas fa-spinner fa-spin"></i>';
            progressContainer.style.display = 'block';
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', unsignedUploadPreset);
            formData.append('cloud_name', cloudName);
            formData.append('api_key', apiKey);
            
            try {
                // 1. Subir a Cloudinary
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const cloudinaryData = await response.json();
                
                if (!response.ok) {
                    throw new Error(cloudinaryData.error.message || 'Error al subir la imagen');
                }
                
                // 2. Guardar metadatos en Firebase
                const imageId = database.ref().child('images').push().key;
                
                const imageData = {
                    id: imageId,
                    secure_url: cloudinaryData.secure_url,
                    public_id: cloudinaryData.public_id,
                    bytes: cloudinaryData.bytes,
                    uploadedBy: currentUser.email,
                    uploadedByUid: currentUser.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`images/${imageId}`).set(imageData);
                
                showStatus('¡Imagen subida con éxito!', 'success');
                createGalleryItem(imageData);
                resetUploadForm();
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'Subir Imagen <i class="fas fa-upload"></i>';
            }
        }
        
        async function deleteImage(imageId, publicId) {
            try {
                // 1. Eliminar de Firebase
                await database.ref(`images/${imageId}`).remove();
                
                // 2. Opcional: Eliminar de Cloudinary (requiere autenticación del lado del servidor)
                // Nota: Para esto necesitarías un backend, ya que requiere tu API secret
                
                showStatus('Imagen eliminada', 'success');
                
                // Eliminar visualmente de la galería
                document.querySelector(`.gallery-item[data-id="${imageId}"]`)?.remove();
            } catch (error) {
                showStatus(`Error al eliminar: ${error.message}`, 'error');
            }
        }
        
        // ... (mantén tus otras funciones existentes) ...
    </script>
</body>
</html>
