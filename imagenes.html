<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Avícola</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    h1, h2, h3 {
      color: #2c3e50;
    }
    
    section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    form div {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    textarea {
      min-height: 80px;
    }
    
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    button:hover {
      background-color: #2980b9;
    }
    
    .delete-btn {
      background-color: #e74c3c;
    }
    
    .delete-btn:hover {
      background-color: #c0392b;
    }
    
    #auth-section {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .auth-form {
      margin-bottom: 30px;
    }
    
    .transaction-item {
      border-left: 4px solid;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .transaction-item.income {
      border-left-color: #2ecc71;
    }
    
    .transaction-item.expense {
      border-left-color: #e74c3c;
    }
    
    .transaction-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .transaction-amount {
      font-weight: bold;
    }
    
    .income .transaction-amount {
      color: #2ecc71;
    }
    
    .expense .transaction-amount {
      color: #e74c3c;
    }
    
    .transaction-comments {
      font-style: italic;
      color: #7f8c8d;
      margin-top: 10px;
    }
    
    #summary-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .summary-card {
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .income {
      color: #2ecc71;
    }
    
    .expense {
      color: #e74c3c;
    }
    
    #username-display {
      font-size: 1.2em;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    @media (max-width: 768px) {
      #summary-section {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>Control Avícola</h1>
  
  <section id="auth-section">
    <h2>Registro</h2>
    <form id="register-form" class="auth-form">
      <div>
        <label for="register-username">Nombre de usuario</label>
        <input type="text" id="register-username" required>
      </div>
      <div>
        <label for="register-email">Correo electrónico</label>
        <input type="email" id="register-email" required>
      </div>
      <div>
        <label for="register-password">Contraseña</label>
        <input type="password" id="register-password" required>
      </div>
      <button type="submit">Registrarse</button>
    </form>
    
    <h2>Iniciar Sesión</h2>
    <form id="login-form" class="auth-form">
      <div>
        <label for="login-email">Correo electrónico</label>
        <input type="email" id="login-email" required>
      </div>
      <div>
        <label for="login-password">Contraseña</label>
        <input type="password" id="login-password" required>
      </div>
      <button type="submit">Iniciar Sesión</button>
    </form>
  </section>
  
  <section id="app-section" style="display: none;">
    <div id="username-display"></div>
    <button id="logout-btn">Cerrar Sesión</button>
    
    <section id="summary-section"></section>
    
    <h2>Registrar Transacción</h2>
    <form id="transaction-form">
      <div>
        <label for="transaction-type">Tipo</label>
        <select id="transaction-type" required>
          <option value="">Seleccionar...</option>
          <option value="income">Ingreso</option>
          <option value="expense">Gasto</option>
        </select>
      </div>
      
      <div>
        <label for="transaction-category">Categoría</label>
        <select id="transaction-category" required>
          <option value="">Seleccionar...</option>
          <optgroup label="Ingresos">
            <option value="venta_pollos">Venta de pollos</option>
            <option value="venta_huevos">Venta de huevos</option>
            <option value="otros_ingresos">Otros ingresos</option>
          </optgroup>
          <optgroup label="Gastos">
            <option value="alimento">Alimento</option>
            <option value="medicina">Medicina/Vacunas</option>
            <option value="equipo">Equipo/Infraestructura</option>
            <option value="mano_obra">Mano de obra</option>
            <option value="otros_gastos">Otros gastos</option>
          </optgroup>
        </select>
      </div>
      
      <div>
        <label for="transaction-amount">Monto</label>
        <input type="number" id="transaction-amount" min="0" step="0.01" required>
      </div>
      
      <div>
        <label for="transaction-description">Descripción</label>
        <input type="text" id="transaction-description" required>
      </div>
      
      <div>
        <label for="transaction-comments">Comentarios (opcional)</label>
        <textarea id="transaction-comments"></textarea>
      </div>
      
      <button type="submit">Guardar Transacción</button>
    </form>
    
    <h2>Historial de Transacciones</h2>
    <div id="transactions-list"></div>
  </section>

  <script type="module" src="app.js"></script>

  <script>


    import { initializeApp } from "firebase/app";
import { 
  getAuth, 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "firebase/auth";
import { 
  getDatabase, 
  ref, 
  push, 
  onValue, 
  remove,
  update
} from "firebase/database";

// Configuración de Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD3MI1klgBSHs1h6QT4VPNoScCfCwMV_Ck",
  authDomain: "usuario-b0384.firebaseapp.com",
  databaseURL: "https://usuario-b0384-default-rtdb.firebaseio.com",
  projectId: "usuario-b0384",
  storageBucket: "usuario-b0384.appspot.com",
  messagingSenderId: "196266170863",
  appId: "1:196266170863:web:4ea57f489df94aba94fe1a"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

// Elementos del DOM
const registerForm = document.getElementById('register-form');
const loginForm = document.getElementById('login-form');
const transactionForm = document.getElementById('transaction-form');
const transactionsList = document.getElementById('transactions-list');
const authSection = document.getElementById('auth-section');
const appSection = document.getElementById('app-section');
const logoutBtn = document.getElementById('logout-btn');
const summarySection = document.getElementById('summary-section');
const usernameDisplay = document.getElementById('username-display');

// Registrar nuevo usuario
registerForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const email = registerForm['register-email'].value;
  const password = registerForm['register-password'].value;
  const username = registerForm['register-username'].value;
  
  createUserWithEmailAndPassword(auth, email, password)
    .then((userCredential) => {
      // Guardar nombre de usuario en la base de datos
      const userRef = ref(database, `users/${userCredential.user.uid}/info`);
      update(userRef, {
        username: username
      }).then(() => {
        registerForm.reset();
        alert('Usuario registrado con éxito');
      });
    })
    .catch((error) => {
      alert(error.message);
    });
});

// Iniciar sesión
loginForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const email = loginForm['login-email'].value;
  const password = loginForm['login-password'].value;
  
  signInWithEmailAndPassword(auth, email, password)
    .then((userCredential) => {
      loginForm.reset();
    })
    .catch((error) => {
      alert(error.message);
    });
});

// Cerrar sesión
logoutBtn.addEventListener('click', () => {
  signOut(auth).catch((error) => {
    alert(error.message);
  });
});

// Agregar nueva transacción (gasto/ingreso)
transactionForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const type = transactionForm['transaction-type'].value;
  const category = transactionForm['transaction-category'].value;
  const amount = parseFloat(transactionForm['transaction-amount'].value);
  const description = transactionForm['transaction-description'].value;
  const comments = transactionForm['transaction-comments'].value;
  
  if (auth.currentUser) {
    const transactionsRef = ref(database, `users/${auth.currentUser.uid}/transactions`);
    push(transactionsRef, {
      type,
      category,
      amount,
      description,
      comments,
      date: new Date().toISOString()
    }).then(() => {
      transactionForm.reset();
    });
  }
});

// Observar cambios de autenticación
onAuthStateChanged(auth, (user) => {
  if (user) {
    // Usuario autenticado
    authSection.style.display = 'none';
    appSection.style.display = 'block';
    
    // Cargar nombre de usuario
    const userRef = ref(database, `users/${user.uid}/info`);
    onValue(userRef, (snapshot) => {
      if (snapshot.exists() && snapshot.val().username) {
        usernameDisplay.textContent = snapshot.val().username;
      }
    });
    
    loadTransactions(user.uid);
    loadSummary(user.uid);
  } else {
    // Usuario no autenticado
    authSection.style.display = 'block';
    appSection.style.display = 'none';
  }
});

// Cargar transacciones
function loadTransactions(userId) {
  const transactionsRef = ref(database, `users/${userId}/transactions`);
  
  onValue(transactionsRef, (snapshot) => {
    transactionsList.innerHTML = '';
    
    if (snapshot.exists()) {
      // Convertir a array y ordenar por fecha
      const transactions = [];
      snapshot.forEach((childSnapshot) => {
        transactions.push({
          id: childSnapshot.key,
          ...childSnapshot.val()
        });
      });
      
      transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Mostrar transacciones
      transactions.forEach((transaction) => {
        const transactionItem = document.createElement('div');
        transactionItem.className = `transaction-item ${transaction.type}`;
        transactionItem.innerHTML = `
          <div class="transaction-header">
            <span class="transaction-date">${formatDate(transaction.date)}</span>
            <span class="transaction-category">${transaction.category}</span>
            <span class="transaction-amount">${transaction.type === 'income' ? '+' : '-'}$${transaction.amount.toFixed(2)}</span>
          </div>
          <div class="transaction-body">
            <p class="transaction-description">${transaction.description}</p>
            ${transaction.comments ? `<p class="transaction-comments"><strong>Comentarios:</strong> ${transaction.comments}</p>` : ''}
          </div>
          <button class="delete-btn" data-id="${transaction.id}">Eliminar</button>
        `;
        transactionsList.appendChild(transactionItem);
      });
      
      // Agregar eventos para eliminar
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const transactionId = e.target.getAttribute('data-id');
          const transactionRef = ref(database, `users/${userId}/transactions/${transactionId}`);
          remove(transactionRef);
        });
      });
    } else {
      transactionsList.innerHTML = '<p>No hay transacciones registradas</p>';
    }
  });
}

// Cargar resumen
function loadSummary(userId) {
  const transactionsRef = ref(database, `users/${userId}/transactions`);
  
  onValue(transactionsRef, (snapshot) => {
    let totalIncome = 0;
    let totalExpense = 0;
    let chickenCount = 0;
    let foodExpense = 0;
    let medicineExpense = 0;
    
    if (snapshot.exists()) {
      snapshot.forEach((childSnapshot) => {
        const transaction = childSnapshot.val();
        
        if (transaction.type === 'income') {
          totalIncome += transaction.amount;
          if (transaction.category === 'venta_pollos') {
            chickenCount += transaction.amount; // Asumiendo que amount es cantidad de pollos
          }
        } else {
          totalExpense += transaction.amount;
          if (transaction.category === 'alimento') {
            foodExpense += transaction.amount;
          } else if (transaction.category === 'medicina') {
            medicineExpense += transaction.amount;
          }
        }
      });
    }
    
    const profit = totalIncome - totalExpense;
    
    summarySection.innerHTML = `
      <div class="summary-card">
        <h3>Resumen Financiero</h3>
        <p>Ingresos: <span class="income">+$${totalIncome.toFixed(2)}</span></p>
        <p>Gastos: <span class="expense">-$${totalExpense.toFixed(2)}</span></p>
        <p>Balance: <span class="${profit >= 0 ? 'income' : 'expense'}">$${profit.toFixed(2)}</span></p>
      </div>
      <div class="summary-card">
        <h3>Resumen Avícola</h3>
        <p>Pollos vendidos: ${chickenCount}</p>
        <p>Gasto en alimento: $${foodExpense.toFixed(2)}</p>
        <p>Gasto en medicina: $${medicineExpense.toFixed(2)}</p>
      </div>
    `;
  });
}

// Formatear fecha
function formatDate(dateString) {
  const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
  return new Date(dateString).toLocaleDateString('es-ES', options);
}
  </script>
</body>
</html>
